---
/*
  Map Page (/map)
  Full-screen interactive map showing all coffee shops visited.
  Uses MapLibre GL JS for rendering and MapTiler for map tiles.

  How it works:
  1. Astro fetches all shops at build time (server-side)
  2. Shop data is passed to the browser as GeoJSON
  3. MapLibre renders the map with markers and popups
  4. Clustering groups nearby shops when zoomed out
*/

import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Fetch all shops and convert to GeoJSON format for MapLibre
const allShops = await getCollection('shops');

// GeoJSON is the standard format for map data
// Each "feature" is a point on the map with properties (name, city, etc.)
const shopGeoJSON = {
  type: 'FeatureCollection',
  features: allShops.map((shop) => ({
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [shop.data.coordinates[1], shop.data.coordinates[0]], // GeoJSON uses [lng, lat]
    },
    properties: {
      id: shop.id,
      name: shop.data.name,
      city: shop.data.city,
      country: shop.data.country,
      rating: shop.data.rating,
      featuredImage: shop.data.featuredImage,
    },
  })),
};
---

<BaseLayout title="Coffee Map" description="Interactive map of coffee shops I've visited around the world">
  <!-- Map container - full width, takes up most of the viewport -->
  <div class="relative">
    <!-- Map info bar -->
    <div class="bg-warm-white border-b border-espresso/10 px-4 py-3">
      <div class="container mx-auto flex items-center justify-between">
        <h1 class="font-heading text-xl font-bold text-espresso">
          Coffee Map
        </h1>
        <span class="text-sm text-charcoal/60">
          {allShops.length} {allShops.length === 1 ? 'shop' : 'shops'} visited
        </span>
      </div>
    </div>

    <!-- The actual map renders here -->
    <div id="map" class="w-full" style="height: calc(100vh - 180px);"></div>
  </div>

  <!--
    Pass shop data from server to browser.
    The script below reads this to place markers on the map.
  -->
  <script
    id="shop-data"
    type="application/json"
    set:html={JSON.stringify(shopGeoJSON)}
  />

  <!-- MapLibre CSS (needed for map controls and popups to look right) -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" />

  <!--
    Map initialization script.
    This runs in the browser (client-side) after the page loads.
  -->
  <script>
    import maplibregl from 'maplibre-gl';

    // Read the shop data that Astro embedded in the page
    const shopDataEl = document.getElementById('shop-data');
    const shopGeoJSON = shopDataEl ? JSON.parse(shopDataEl.textContent || '{}') : { type: 'FeatureCollection', features: [] };

    // MapTiler API key from environment variable
    const MAPTILER_KEY = import.meta.env.PUBLIC_MAPTILER_KEY;

    // Initialize the map
    const map = new maplibregl.Map({
      container: 'map',
      // MapTiler style URL - "streets" is a clean, readable style
      style: `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`,
      center: [20, 30],   // Starting center (rough center of the world)
      zoom: 2,            // Starting zoom level (zoomed out to see the world)
    });

    // Add zoom and rotation controls (the +/- buttons)
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // Wait for the map style to finish loading before adding data
    map.on('load', () => {
      /*
        Add shop locations as a GeoJSON data source.
        Clustering is enabled so nearby shops group together when zoomed out.
      */
      map.addSource('shops', {
        type: 'geojson',
        data: shopGeoJSON,
        cluster: true,          // Enable clustering
        clusterMaxZoom: 14,     // Stop clustering at zoom level 14
        clusterRadius: 50,      // Cluster points within 50px of each other
      });

      /*
        Cluster circles - shown when multiple shops are close together.
        The circle size and color change based on how many shops are in the cluster.
      */
      map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'shops',
        filter: ['has', 'point_count'], // Only show for clustered points
        paint: {
          'circle-color': [
            'step',
            ['get', 'point_count'],
            '#C05717',  // Rust color for small clusters (< 5)
            5,
            '#B8860B',  // Gold for medium clusters (5-10)
            10,
            '#3D2314',  // Espresso for large clusters (10+)
          ],
          'circle-radius': [
            'step',
            ['get', 'point_count'],
            20,   // 20px radius for small clusters
            5,
            25,   // 25px for medium
            10,
            30,   // 30px for large
          ],
          'circle-stroke-width': 2,
          'circle-stroke-color': '#FFFAF5', // Warm white border
        },
      });

      // Cluster count label (the number inside the circle)
      map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'shops',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': '{point_count_abbreviated}',
          'text-size': 14,
        },
        paint: {
          'text-color': '#FFFAF5', // Warm white text
        },
      });

      /*
        Individual shop markers (unclustered points).
        These appear when zoomed in enough to see individual shops.
      */
      map.addLayer({
        id: 'unclustered-point',
        type: 'circle',
        source: 'shops',
        filter: ['!', ['has', 'point_count']], // Only for non-clustered points
        paint: {
          'circle-color': '#C05717',    // Rust color
          'circle-radius': 10,
          'circle-stroke-width': 3,
          'circle-stroke-color': '#FFFAF5', // Warm white border
        },
      });

      /*
        Click on a cluster → zoom in to see individual shops.
      */
      map.on('click', 'clusters', async (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        const source = map.getSource('shops') as maplibregl.GeoJSONSource;
        const zoom = await source.getClusterExpansionZoom(clusterId);
        map.easeTo({
          center: (features[0].geometry as GeoJSON.Point).coordinates as [number, number],
          zoom,
        });
      });

      /*
        Click on an individual shop → show a popup with details.
      */
      map.on('click', 'unclustered-point', (e) => {
        if (!e.features || e.features.length === 0) return;

        const feature = e.features[0];
        const coords = (feature.geometry as GeoJSON.Point).coordinates.slice() as [number, number];
        const { name, city, country, rating, id } = feature.properties;

        // Build star rating display
        const stars = '★'.repeat(rating) + '☆'.repeat(5 - rating);

        // Create the popup HTML
        const popupHTML = `
          <div style="font-family: 'Inter', sans-serif; min-width: 180px;">
            <h3 style="font-family: 'Playfair Display', serif; font-size: 16px; font-weight: bold; color: #3D2314; margin: 0 0 4px 0;">
              ${name}
            </h3>
            <p style="font-size: 13px; color: #2C2C2C; opacity: 0.7; margin: 0 0 6px 0;">
              ${city}, ${country}
            </p>
            <p style="color: #B8860B; font-size: 14px; margin: 0 0 8px 0;">${stars}</p>
            <a href="/shops/${id}" style="font-size: 13px; color: #C05717; text-decoration: none; font-weight: 600;">
              View details →
            </a>
          </div>
        `;

        new maplibregl.Popup({ offset: 15 })
          .setLngLat(coords)
          .setHTML(popupHTML)
          .addTo(map);
      });

      // Change cursor to pointer when hovering over clickable elements
      map.on('mouseenter', 'clusters', () => { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', 'clusters', () => { map.getCanvas().style.cursor = ''; });
      map.on('mouseenter', 'unclustered-point', () => { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', 'unclustered-point', () => { map.getCanvas().style.cursor = ''; });

      /*
        If there are shops, zoom to fit all of them in view.
        Otherwise keep the default world view.
      */
      if (shopGeoJSON.features.length > 0) {
        const bounds = new maplibregl.LngLatBounds();
        shopGeoJSON.features.forEach((feature: any) => {
          bounds.extend(feature.geometry.coordinates);
        });
        map.fitBounds(bounds, { padding: 60, maxZoom: 12 });
      }
    });
  </script>
</BaseLayout>
